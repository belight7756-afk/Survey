<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>연구용 설문</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        .stage { display: none; }
        .question { margin-bottom: 1.5em; border: 1px solid #ccc; padding: 1em; border-radius: 8px; }
        .question img { max-width: 100%; height: auto; margin-top: 1em; margin-bottom: 1em; border: 1px solid #ddd; border-radius: 4px; }
        .question p { font-weight: bold; }
        .question label { display: block; margin: 0.5em 0; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: #007BFF; color: white; border: none; border-radius: 5px; }
        button:hover { background-color: #0056b3; }
        input[type="text"] { padding: 8px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; }
        .likert-scale label { display: inline-block; width: 50px; text-align: center; }
    </style>
</head>
<body>

    <div id="stage1-start" class="stage">
        <h2>설문 시작</h2>
        <p>안녕하십니까? 저희는 한국항공대학교 항공교통물류학부 학술제 항공교통 세션의 '항교물의 문단속' 팀입니다. 현재 '항공기 비상문 개방 사고의 리스크 분석 및 대응 프로토콜 마련'에 대한 연구를 진행하고 있습니다. 본 시나리오 기반 설문은 저희가 만든 의사결정 프로토콜의 효과를 검증하기 위한 실험으로, 총 두번의 퀴즈와 프로토콜 설명, 사후 설문으로 구성되어있습니다. 단기간의 내용 파악이 어려움을 인지하고, 프로토콜의 의의에 초점을 두고 조사하고 있기 때문에 퀴즈의 난이도 및 점수에 대해서는 부담 갖지 않으셔도 됩니다.</p>
        <p>우선, 기본 사항에 대해 질문드리겠습니다.</p>
        <label for="userId">이름을 입력해주세요:</label><br>
        <input type="text" id="userId" name="userId" required><br><br>
        <label for="majorStatus">전공자 여부를 입력해주세요 (예: 전공자(전공명/학년), 비전공, 기타):</label><br>
        <input type="text" id="majorStatus" name="majorStatus" required><br><br>
        <button id="startSurveyBtn">설문 시작하기</button>
    </div>

    <div id="stage2-pre" class="stage">
        <h2>1차 설문 (실험 전)</h2>
        <p>아래 사진을 보고 문제에 답해주세요.</p>
        <form id="preSurveyForm"></form>
        <button id="nextToProtocolBtn">다음</button>
    </div>

    <div id="stage3-protocol" class="stage">
        <h2>프로토콜 교육</h2>
        <img src="images/0.png" width="800">
        <img src="images/1.png" width="800">
        <p>저희는 항공기 비상문 개방 대응 프로토콜을 마련하기 위해, 위와 같은 전제를 기반으로 다양한 시나리오를 만들었습니다.</p>
        <p>각 시나리오에 따른 의사결정 흐름은 다음과 같으며, 내용이 방대하여 사진으로만 설명드림에 양해부탁드립니다.</p>
        
        <img src="images/2.png" width="1200">


        <img src="images/3.png" width="1200">


        <img src="images/4.png" width="1200">


        <img src="images/5.png" width="1200">


        <img src="images/6.png" width="1200">


        <img src="images/7.png" width="1200">


        <img src="images/8.png" width="800">


        <p>교육을 마친 후 '다음' 버튼을 눌러주세요.</p>
        <button id="nextToPostBtn">다음 (2차 설문 시작)</button>
    </div>

    <div id="stage4-post" class="stage">
        <h2>2차 설문 (실험 후)</h2>
        <p>아래 사진을 보고 문제에 답해주세요.</p>
        <form id="postSurveyForm"></form>
        <button id="nextToFinalSurveyBtn">최종 설문으로 이동</button>
    </div>

    <div id="stage5-final" class="stage">
        <h2>사후 설문</h2>
        <p>해당 프로토콜의 효과에 대해 검증하기 위해, 참가자분들의 학습 경험 및 프로토콜 개선 방안에 대한 질문을 드리고자 합니다.</p>
        <form id="finalSurveyForm"></form>
        <button id="submitFinalBtn">최종 제출</button>
    </div>
    
    <div id="stage6-complete" class="stage">
        <h2>설문 완료</h2>
        <p>참여해주셔서 감사합니다.</p>
    </div>

    <script>
        // ====== 1. 질문 Pool (각 단계별 질문을 별도로 정의) ======
        const preQuestions = [
            { q: "비상 상황에서 기내 운항 최종 결정을 내려야 하는 주체는 누구인가?", options: ["객실승무원","조종사","공항운영자","항공사 운영본부"], answer: "조종사" },
            { q: "공항 운영자의 비상문 개방사고 시 대응과정과 가장 거리가 먼 행동은 무엇인가?", options: ["해당 공항의 이륙항공기에 대한 release 발부 중단","활주로 안전 확보 조치 시행","항공사 운영본부와 협력","사고 대응 인력 현장 투입 및 필수 기능 인력 유지"], answer: "해당 공항의 이륙항공기에 대한 release 발부 중단" },
            { q: "원인이 ‘테러·정신질환·마약’이라면, 적절한 후속 절차는?", options: ["정비절차","보안절차","응급구조절차","사고조사절차"], answer: "보안절차" },
            { q: "항공기가 지상이동 중 비상문이 개방되었다. 즉각적인 적절한 조치는?", options: ["항공기 정지","승객 하기","계류장 복귀","이륙 준비"], answer: "항공기 정지" },
            { q: "지상이동 중 비상문이 강제 개방되어 계류장으로 복귀 시, 자력복귀가 가능한 경우로 옳지 않은 것은?", options: ["1) 항공기 비상문 주변의 경미한 파손","비상탈출 슬라이드의 이탈","슬라이드 흡입으로 인한 엔진 및 기어 손상","항공기 내 안전 위해요인 제거"], answer: "슬라이드 흡입으로 인한 엔진 및 기어 손상" },
            { q: "접근 중 400ft에서 비상문 강제개방 사고 발생 시 가장 우선시해야 하는 조치는?", options: ["기내 안전 확인","지상지원 요청","보안 및 장비 점검","슬라이드 교체"], answer: "기내 안전 확인" },
            { q: "공항으로 접근 중인 A321의 현재 고도가 1000ft일 때 비상문이 강제 개방되었다. 조종사의 적절한 조치와 거리가 먼 것은?", options: ["Continue Approach","기내 콜을 통한 기내안전확보 확인","Go Around","객실로 이동해 개방자 제압"], answer: "객실로 이동해 개방자 제압" },
            { q: "DA/H 미만 접근 중 개방자 제압 과정에서 승객 2명의 생명이 위험할 때 착륙 후 절차로 가장 적절한 것은?", options: ["활주로 정지 → 지상이동 요청","활주로 정지 → 기내 안전 확보 → 지상지원 요청","고속탈출유도로 이동 → 지상지원 요청","활주로 정지 → 기내 안전 확보 → 항공기 손상 여부 확인"], answer: "활주로 정지 → 기내 안전 확보 → 지상지원 요청" },
            { q: "출발 공항에서 운항이 중단된 경우 항공사 대응으로 가장 적절한 것은?", options: ["행위자 인도 후 재출발","대체 항공기 마련","모든 승객 귀가 후 환불·보상","항공편 취소"], answer: "대체 항공기 마련" },
            { q: "도착 공항에서 해당 사고가 발생한 경우, 항공사의 부적절한 조치는?", options: ["지연된 하기에 대한 승객 보상","해당 항공편의 새로운 OFP 작성","사고 항공기의 정비","사고 항공기의 스케줄 수정"], answer: "해당 항공편의 새로운 OFP 작성" }
        ];

        const postQuestions = [
            { q: "해당 사고 시 조직 내 직접적인 이해관계자로 포함되지 않는 사람은 누구인가?", img: "images/21.png", options: ["지상조업 정비팀","항공기 제작사","지상조업 램프팀","항공사 보안팀"], answer: "항공기 제작사" },
            { q: "본 프로토콜은 결정트리를 따르도록 설계되었으나, 실제 대응원칙은 무엇인가?", img: "images/22.png", options: ["메뉴얼의 엄격 준수","상급자의 서면 확인 후 실행","상황에 따라 가장 합리적인 방법 선택","관제탑 지시 순응"], answer: "상황에 따라 가장 합리적인 방법 선택" },
            { q: "항공기 비상문 개방 원인이 보안(테러,마약 등)으로 판별되었을 때, 우선적으로 필요한 조치는?", img: "images/23.png", options: ["슬라이드 제거","행위자 식별 및 제압","항공기 손상 여부 확인","하선장비 가능 여부 확인"], answer: "행위자 식별 및 제압" },
            { q: "V1 미만에서 비상문이 개방된 경우 올바른 조치는? ", img: "images/26.png", options: ["폐문 후 정상 운항","정지 (Rejected Take-off)","활주로 끝까지 이륙 후 회항","기내 안전 방송 후 회항"], answer: "정지 (Rejected Take-off)" },
            { q: "항공기가 이륙 중 V1 이상에서 정비 문제로 비상문이 개방되었을 때, 조종사의 알맞은 조치가 아닌 것은?", img: "images/26.png", options: ["브레이크","관제탑에 상황 보고","이륙완료 후 선회접근","항공사 종합통제팀에 보고"], answer: "브레이크" },
            { q: "A321 항공기가 정비 문제로 순항 중에 비상문이 개방되었다. 즉각 대응 절차는?", img: "images/26.png", options: ["항공기 손상 파악","Landing","보안절차 시행","기내안전확보, 안전고도비행"], answer: "기내안전확보, 안전고도비행" },
            { q: "Touch-down 중 슬라이드가 활주로 상에서 전개·이탈된 경우 ATC의 올바른 조치는?", img: "images/27.png", options: ["활주로 FOD 점검","타 항공기 착륙 허가","타 항공기 이륙 허가","Vacate 지시"], answer: "활주로 FOD 점검" },
            { q: "비상문이 개방된 상황에서 안전하게 랜딩 했으나 행위자 제압이 완료되지 않았다면 절차는?", img: "images/28.png", options: ["Stop","Roll-Out","Vacate","Go Around"], answer: "Stop" },
            { q: "활주로 상에서 비상문이 개방되었을 경우, FOD 확인 절차의 올바른 흐름은?", img: "images/29.png", options: ["활주로 점검 → FOD 제거 여부 확인 → TWR 보고 → 이용 재개","활주로 점검 → TWR 보고 → 이용 재개","TWR 보고 → 활주로 폐쇄","TWR 보고 → 즉시 이용 재개"], answer: "활주로 점검 → FOD 제거 여부 확인 → TWR 보고 → 이용 재개" },
            { q: "도착 공항과 달리, 출발 공항에서만 추가적으로 요구되는 절차는?", img: "images/210.png", options: ["대체편 마련","새로운 OFP 수립","항공기 정비","사고 조사"], answer: "새로운 OFP 수립" }
        ];

        const finalQuestions = [
            { q: "해당 프로토콜을 통해 비상문 강제 개방 상황에서 각 이해관계자(조종사/객실/운항통제/관제/지상)의 책임 경계가 명확해졌다고 생각한다.", type: "likert" },
            { q: "단계별 지시사항이 명확하다.", type: "likert" },
            { q: "시나리오의 현실성이 충분하다.", type: "likert" },
            { q: "자료 형식(영상·도식·체크리스트·현장 카드)이 이해에 도움이 되었다.", type: "likert" },
            { q: "반복 학습(요약본·포켓가이드·퀴즈 재응시 등) 지원이 필요할 것으로 생각된다.", type: "likert" },
            { q: "교육 시 도움이 되었던 점 / 헷갈렸던 점 / 추가로 필요하다고 생각하는 것.", type: "text" }
        ];

        // ====== 2. 전역 변수 설정 ======
        let userId = '';
        let majorStatus = '';
        let preStartTime;
        let postStartTime;
        let finalSurveyStartTime;
        
        // Google Apps Script URL (이 부분을 본인의 URL로 반드시 교체해야 합니다!)
        const scriptURL = "https://script.google.com/macros/s/AKfycbzpRHogHPSQR-USO7K1K10HO5jKKTI1i2T7xKOjBsuw6rWD5_06L0PI9Sq_FyWwVjYrAQ/exec";

        // ====== 3. DOM 요소 및 함수 ======
        const showStage = (id) => {
            document.querySelectorAll('.stage').forEach(el => el.style.display = 'none');
            document.getElementById(id).style.display = 'block';
        };

        const createQuestions = (formElement, questionList, isFinal = false) => {
            formElement.innerHTML = '';
            questionList.forEach((item, idx) => {
                const div = document.createElement("div");
                div.className = "question";
                if (!isFinal) {
                    div.innerHTML = `
                        <p>Q${idx + 1}. ${item.q}</p>
                        <img src="${item.img}" alt="Question ${idx + 1} Image">
                    `;
                    item.options.forEach(opt => {
                        div.innerHTML += `
                            <label>
                                <input type="radio" name="q${idx}" value="${opt}" required> ${opt}
                            </label><br>`;
                    });
                } else {
                    if (item.type === "likert") {
                        div.innerHTML = `<p>${idx + 1}. ${item.q}</p>`;
                        div.innerHTML += '<div class="likert-scale">';
                        for (let i = 1; i <= 5; i++) {
                            div.innerHTML += `<label><input type="radio" name="final_q${idx}" value="${i}" required> ${i}</label>`;
                        }
                        div.innerHTML += '</div>';
                    } else if (item.type === "text") {
                        div.innerHTML = `<p>${idx + 1}. ${item.q}</p>`;
                        div.innerHTML += `<textarea name="final_q${idx}" rows="5" cols="50" placeholder="여기에 답변을 입력해주세요." required></textarea>`;
                    }
                }
                formElement.appendChild(div);
            });
        };

        const getSurveyResults = (formElement, questionList, isFinal = false) => {
            const results = { allAnswered: true, answers: [], correct: 0, wrong: 0, duration: 0 };
            
            if (isFinal) {
                questionList.forEach((item, idx) => {
                    const name = `final_q${idx}`;
                    let value = '';
                    if (item.type === "likert") {
                        const checked = formElement.querySelector(`input[name="${name}"]:checked`);
                        value = checked ? checked.value : "";
                        if (!checked) results.allAnswered = false;
                    } else if (item.type === "text") {
                        const textarea = formElement.querySelector(`textarea[name="${name}"]`);
                        value = textarea ? textarea.value.trim() : "";
                        if (!value) results.allAnswered = false;
                    }
                    results.answers.push(value);
                });
            } else { // Pre and Post
                questionList.forEach((item, idx) => {
                    const checked = formElement.querySelector(`input[name="q${idx}"]:checked`);
                    const ans = checked ? checked.value : "";
                    if (!checked) results.allAnswered = false;
                    results.answers.push(ans);
                    if (ans === item.answer) results.correct++;
                    else results.wrong++;
                });
            }
            return results;
        };

        const sendData = (payload) => {
            return fetch(scriptURL, {
                method: "POST",
                body: JSON.stringify(payload)
            }).then(res => res.json());
        };

    // ====== 4. 이벤트 리스너 ======
    document.getElementById('startSurveyBtn').addEventListener('click', () => {
        const inputId = document.getElementById('userId').value.trim();
        const inputMajorStatus = document.getElementById('majorStatus').value.trim();

        if (!inputId || !inputMajorStatus) {
            alert("이름과 전공 여부를 모두 입력해주세요.");
            return;
        }
        userId = inputId;
        majorStatus = inputMajorStatus;

        alert("기본 정보가 입력되었습니다. 이제 1차 설문을 시작합니다.");
        preStartTime = Date.now();
        createQuestions(document.getElementById('preSurveyForm'), preQuestions);
        showStage('stage2-pre');
    });

    document.getElementById('nextToProtocolBtn').addEventListener('click', () => {
        const preSurveyForm = document.getElementById('preSurveyForm');
        const { correct, wrong, answers, allAnswered } = getSurveyResults(preSurveyForm, preQuestions);

        if (!allAnswered) {
            alert("모든 질문에 답변해주세요.");
            return;
        }

        const duration = Math.round((Date.now() - preStartTime) / 1000);

        const payload = {
            respondent: userId, // 'respondent'로 분리
            majorStatus: majorStatus, // 'majorStatus'로 분리
            phase: "pre",
            time: duration,
            correct: correct,
            wrong: wrong,
            answers: answers
        };
        
        sendData(payload)
            .then(res => {
                alert("1차 설문이 저장되었습니다. 이제 프로토콜 교육을 진행합니다.");
                showStage('stage3-protocol');
            })
            .catch(err => alert("1차 설문 데이터 저장 중 에러 발생: " + err));
    });

    document.getElementById('nextToPostBtn').addEventListener('click', () => {
        postStartTime = Date.now();
        createQuestions(document.getElementById('postSurveyForm'), postQuestions);
        showStage('stage4-post');
    });

    document.getElementById('nextToFinalSurveyBtn').addEventListener('click', () => {
        const postSurveyForm = document.getElementById('postSurveyForm');
        const { correct, wrong, answers, allAnswered } = getSurveyResults(postSurveyForm, postQuestions);
        
        if (!allAnswered) {
            alert("모든 질문에 답변해주세요.");
            return;
        }

        const duration = Math.round((Date.now() - postStartTime) / 1000);

        const payload = {
            respondent: userId, // 'respondent'로 분리
            majorStatus: majorStatus, // 'majorStatus'로 분리
            phase: "post",
            time: duration,
            correct: correct,
            wrong: wrong,
            answers: answers
        };

        sendData(payload)
            .then(res => {
                alert("2차 설문이 저장되었습니다. 이제 사후 설문을 진행합니다.");
                finalSurveyStartTime = Date.now();
                createQuestions(document.getElementById('finalSurveyForm'), finalQuestions, true);
                showStage('stage5-final');
            })
            .catch(err => alert("2차 설문 데이터 저장 중 에러 발생: " + err));
    });

    document.getElementById('submitFinalBtn').addEventListener('click', () => {
        const finalSurveyForm = document.getElementById('finalSurveyForm');
        const { allAnswered, answers } = getSurveyResults(finalSurveyForm, finalQuestions, true);

        if (!allAnswered) {
            alert("모든 질문에 답변해주세요.");
            return;
        }

        const duration = Math.round((Date.now() - finalSurveyStartTime) / 1000);

        const payload = {
            respondent: userId, // 'respondent'로 분리
            majorStatus: majorStatus, // 'majorStatus'로 분리
            phase: "final",
            time: duration,
            answers: answers
        };

        sendData(payload)
            .then(res => {
                alert("사후 설문이 저장되었습니다. 참여해주셔서 감사합니다!");
                showStage('stage6-complete');
            })
            .catch(err => alert("사후 설문 데이터 저장 중 에러 발생: " + err));
    });

    // 초기 화면 표시
    document.addEventListener('DOMContentLoaded', () => {
        showStage('stage1-start');
    });
</script>
</body>
</html>