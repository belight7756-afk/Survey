<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>연구용 설문</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        .stage { display: none; } /* 각 단계를 기본적으로 숨김 */
        .question { margin-bottom: 1em; }
    </style>
</head>
<body>

    <div id="stage1-start" class="stage">
        <h2>설문 시작</h2>
        <label for="userId">참가자 ID를 입력해주세요:</label><br>
        <input type="text" id="userId" name="userId" required><br><br>
        <button id="startSurveyBtn">설문 시작하기</button>
    </div>

    <div id="stage2-pre" class="stage">
        <h2>1차 설문 (실험 전)</h2>
        <form id="preSurveyForm"></form>
        <button id="nextToProtocolBtn">다음</button>
    </div>

    <div id="stage3-protocol" class="stage">
        <h2>프로토콜 교육</h2>
        <p>저희가 만든 프로토콜은 항공기의 비상문 개방 시 항공기별 개방위치, 개방원인에 따라 어떠한 절차가 이뤄져야 하는지를 다루고 있습니다.</p>
        <p>항공종사자가 아닌 이상 단기간의 내용 파악이 어려움을 인지하고, 프로토콜의 의의에 초점을 두고 조사하므로 부담 갖지 않으셔도 됩니다.</p>
        <p>프로토콜 내용이 방대하여 사진으로 최대한 간략하게 교육하고자 합니다.</p>
        
        <h2>프로토콜 흐름</h2>
        <img src="images/프로토콜 시각화.png" alt="Protocol to Emergency Exit Door Open Case" width="1400">
        <p>이것은 전체 프로토콜의 흐름입니다.</p>

        <h2>DA/H 미만</h2>
        <img src="images/DAH 미만.png" alt="DA/H 미만" width="1200">
        <p>'접근-DAH미만' 부분의 경우, 사진과 같이 세부적으로 절차가 나눠지며, 지상지원요청으로 절차가 마무리됩니다.</p>

        <h2>DA/H 이상</h2>
        <img src="images/DAH 이상.png" alt="DA/H 이상" width="800">
        <p>'접근-DAH이상' 부분의 경우, 안전고도인 1000ft를 기준으로 경우가 나눠지며, 사진과 같이 절차가 이뤄집니다.</p>

        <h2>원인파악</h2>
        <img src="images/원인파악.png" alt="원인파악" width="1200">
        <p>'원인파악' 부분의 경우, 정지-보안/정비 부분을 보시면 됩니다. 원인에 따라 사진과 같이 절차가 이뤄집니다.</p>

        <h2>지상이동</h2>
        <img src="images/지상이동.png" alt="지상이동" width="1200">
        <p>'지상이동' 부분의 경우, 상단의 '복귀'에 해당하는 부분을 보시면 됩니다. 항공기 이동 가능 여부에 따라 사진과 같이 절차가 이뤄집니다.</p>

        <p>교육을 마친 후 '다음' 버튼을 눌러주세요.</p>
        <button id="nextToPostBtn">다음 (2차 설문 시작)</button>
    </div>

    <div id="stage4-post" class="stage">
        <h2>2차 설문 (실험 후)</h2>
        <img src="images/프로토콜 시각화.png" alt="Protocol to Emergency Exit Door Open Case" width="1400">
        <form id="postSurveyForm"></form>
        <button id="submitFinalBtn">최종 제출</button>
    </div>
    
    <div id="stage5-complete" class="stage">
        <h2>설문 완료</h2>
        <p>참여해주셔서 감사합니다.</p>
    </div>

    <script>
        // ====== 1. 질문 Pool ======
        const allQuestions = [
            { q: "B737기가 지상에서 비상문이 개방되었다. 다음에 이뤄져야 할 절차는?", options: ["항공기 정지","승객 대피","TAXI로 이동","복귀"], answer: "항공기 정지" },
            { q: "비상문 개방의 원인이 '테러, 정신질환, 마약'이라면, 다음으로 이뤄질 절차는?", options: ["정비절차 시행","보안절차 시행","승객 승하","관계인 파악"], answer: "보안절차 시행" },
            { q: "비상문 개방의 원인이 '인적오류 및 기계결함'이라면, 다음으로 이뤄질 절차는?", options: ["보안절차 시행","슬라이드 교체","정비절차 시행","보안 및 장비 점검"], answer: "정비절차 시행" },
            { q: "비상문 개방으로 인하여 항공기가 앞선 절차들을 마치고 항공기가 이동이 가능하다면, 다음으로 이뤄져야 할 절차는?", options: ["행위자 식별","활주로 정지","항공기 재점검","관계인 파악"], answer: "관계인 파악" },
            { q: "항공기의 손상여부를 확인한 결과, 손상이 없다면, 다음으로 이뤄져야 할 절차는?", options: ["자력 복귀","견인 복귀","승객 승하","하선장비 이용"], answer: "자력 복귀" },
            { q: "공항으로 접근중인 A321 항공기의 현재 고도는 3500ft이고 DA/H이상 고도에 있다. 이때 비상문이 개방되였는데 다음으로 해야 할 절차는?", options: ["Continue Approach","기내안전확보","Go Around","개방자 제압"], answer: "Go Around" },
            { q: "DA/H이상에 있는 항공기가 공항 접근 중에 한 승객이 비상문을 개방 하려 한다. 승무원들이 제압 시도를 하고 있지만 그 승객은 계속 비상문을 개방 하려고 한다. 사무장이 이 소식을 조종사에게 전하자 곳바로 조종사는 기내난동이 있다고 판단하였다. 다음으로 해야 할 절차는?", options: ["행위자 식별->행위자 인도","착륙 진행->개방자 제압","개방자 제압->지상지원요청","Go Around->안전 확보 후 재접근"], answer: "Go Around->안전 확보 후 재접근"},
            { q: "DA/H미만에 있는 항공기가 접근중 비상문이 개방되였다. 조종사는 Go Around 한 후에 안전확인하고 착륙 진행을 마쳤다. 하지만 아직도 개방자는 제압이 완전히 안됀 상태이다. 이 다음으로 수행해야 할 절차 순서는 무었인가?", options: ["활주로 정지->지상지원 요청","활주로 정지->기내 안전 확보->지상지원 요청","고속탈출유도로 이동->지상지원 요청","활주로 정지->기내 안전 확보->항공기 손상 여부 확인"], answer: "활주로 정지->기내 안전 확보->지상지원 요청"},
            { q: "DA/H미만에 있는 항공기가 접근중 비상문이 개방되였다. 조종사는 Go Around 한 후에 안전확인하고 착륙 진행을 마쳤다. 개방자는 없었고 항공기 손상으로 인한 비상문이 개방 되였다. 이 다음으로 수행해야 할 절차 순서는 무었인가?", options: ["활주로 정지->지상지원 요청","활주로 정지->기내 안전 확보->지상지원 요청","고속탈출유도로 이동->지상지원 요청","활주로 정지->기내 안전 확보->항공기 손상 여부 확인"], answer: "활주로 정지->지내 안전 확보->지상지원 요청"},
            { q: "DA/H미만에 있는 항공기가 접근중 비상문이 개방되였다. 조종사는Go Around 한 후에 안전확인하고 착륙 진행을 마쳤다. 개방자는 승무원들이 완전히 제압했다. 이 다음으로 수행해야 할 절차 순서는 무엇인가?", options: ["활주로 정지->지상지원 요청","활주로 정지->기내 안전 확보->지상지원 요청","고속탈출유도로 이동->지상지원 요청","활주로 정지->기내 안전 확보->항공기 손상 여부 확인"], answer: "고속탈출유도로 이동->지상지원 요청"},
            { q: "'테러, 정신질환, 마약'이 개방 원인으로 판단되어 보안절차를 시행하고, 브레이크 행위자 식별 안전 확인이 완료되었다. 램프에서 이뤄져야 할 절차는?", options: ["이동", "문 닫기","슬라이드 교체","견인 복귀"], answer: "문 닫기"},
            { q: "항공기의 손상여부를 확인한 결과, 손상이 있다면, 다음으로 이뤄져야 할 절차는?", options: ["행위자 인도","행위자 식별","승하 및 보안점검","관계인 파악"], answer: "승하 및 보안점검"},
            { q: "'인적오류 및 기계결함'이 개방 원인으로 밝혀져 정비절차를 시행하고, 브레이크 안전 확인 후 지상지원을 요청하였다. 정비에서 이뤄져야 할 절차는?", options: ["문 닫기","자력복귀","보안절차 시행","슬라이드 교체"], answer: "슬라이드 교체"},
            { q: "B777 항공기가 이륙 중 v1 미만에서 비상문이 개방되었고, 정지하여, 개방원인을 정비로 발견하였다. 다음으로 해야 할 절차는?", options: ["기내안전확인","지상지원요청","보안 및 장비 점검","슬라이드 교체"], answer: "기내안전확인"},
            { q: "B777 항공기가 이륙 중 v1 이상에서 비상문이 개방되었다. 다음으로 해야 할 절차는?", options: ["랜딩","Go Around","개방자 제압","보안절차 시행"], answer: "Go Around"},
            { q: "DA/H미만에 있는 항공기가 접근중 비상문이 개방되였다. 조종사는Go Around 한 후에 안전확인하고 착륙 진행을 마쳤다. 조종사는 개방자 제압 과정에서 승객 2명이 치명상을 입었다고 보고를 받았다. 이 다음으로 수행해야 할 절차 순서는 무었인가?", options: ["활주로 정지->지상지원 요청","활주로 정지->기내 안전 확보->지상지원 요청","고속탈출유도로 이동->지상지원 요청","활주로 정지->기내 안전 확보->항공기 손상 여부 확인"], answer: "활주로 정지->기내 안전 확보->지상지원 요청"},
            { q: "A321 항공기가 순항중에 비상문이 개방되었다. 즉각 대응으로 다음 어떤 절차를 수행해야 하는가?", options: ["항공기 손상 파악","Landing", "보안절차 시행","기내안전확보, 안전고도비행"], answer: "기내안전확보, 안전고도비행"},
            { q: "B737 항공기가 taxi 하고 있는 도 중 비상문이 개방 되었다. 다음으로 어떤 절차를 수행해야 하는가?", options: ["고속탈출유도로 이동","Gate로 이동","기내안전확인","정지"], answer: "정지"},
            { q: "공항으로 접근중인 A330 항공기의 현재 고도는 1500ft이고 DA/H미만 고도에 있다. 이때 비상문이 개방되였는데 다음으로 해야 할 절차는?", options: ["Continue Approach","기내안전확보","Vacate","Go Around"], answer: "Go Around"},
            { q: "공항으로 접근중인 A330 항공기의 현재 고도는 500ft이고 DA/H미만 고도에 있다. 이때 비상문이 개방되였는데 다음으로 해야 할 절차는?", options: ["Go Around","기내안전확보","Continue Approach","Vacate"], answer: "Go Around"},
        ];

        // ====== 2. 전역 변수 설정 ======
        let userId = '';
        let preStartTime;
        let postStartTime;
        let preQuestions; // 1차 설문용 질문
        let postQuestions; // 2차 설문용 질문

        // Google Apps Script URL
        const scriptURL = "https://script.google.com/macros/s/AKfycby4G5gWZeEz9bF49nrJeP6WXosP63OMldAB7Up9D_eFbA5NdNbqZqjUPm6dMC5zIZLjUw/exec";

        // ====== 3. DOM 요소 및 함수 ======
        const showStage = (id) => {
            document.querySelectorAll('.stage').forEach(el => el.style.display = 'none');
            document.getElementById(id).style.display = 'block';
        };

        // 질문을 섞고 10개만 선택하는 함수
        const getRandomQuestions = (questionList, num) => {
            const shuffled = [...questionList].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, num);
        };

        const createQuestions = (formElement, questionList) => {
            formElement.innerHTML = ''; // 기존 내용 지우기
            questionList.forEach((item, idx) => {
                const div = document.createElement("div");
                div.className = "question";
                div.innerHTML = `<p>Q${idx + 1}. ${item.q}</p>`;
                item.options.forEach(opt => {
                    div.innerHTML += `
                        <label>
                            <input type="radio" name="q${idx}" value="${opt}"> ${opt}
                        </label><br>`;
                });
                formElement.appendChild(div);
            });
        };

        const getSurveyResults = (formElement, questionList) => {
            let correct = 0, wrong = 0;
            const answers = [];
            questionList.forEach((item, idx) => {
                const checked = formElement.querySelector(`input[name="q${idx}"]:checked`);
                const ans = checked ? checked.value : "";
                answers.push(ans);
                if (ans === item.answer) correct++;
                else wrong++;
            });
            return { correct, wrong, answers };
        };

        const sendData = (payload) => {
            return fetch(scriptURL, {
                method: "POST",
                body: JSON.stringify(payload)
            }).then(res => res.json());
        };

        // ====== 4. 이벤트 리스너 ======
        document.getElementById('startSurveyBtn').addEventListener('click', () => {
            const inputId = document.getElementById('userId').value.trim();
            if (!inputId) {
                alert("참가자 ID를 입력해주세요.");
                return;
            }
            userId = inputId;
            preStartTime = Date.now();
            preQuestions = getRandomQuestions(allQuestions, 10); // 1차 설문용 10개 질문 선택
            createQuestions(document.getElementById('preSurveyForm'), preQuestions);
            showStage('stage2-pre');
        });

        document.getElementById('nextToProtocolBtn').addEventListener('click', () => {
            const preSurveyForm = document.getElementById('preSurveyForm');
            const { correct, wrong, answers } = getSurveyResults(preSurveyForm, preQuestions);
            const duration = Math.round((Date.now() - preStartTime) / 1000);

            const payload = {
                respondent: userId,
                phase: "pre",
                time: duration,
                correct: correct,
                wrong: wrong,
                answers: answers
            };
            
            sendData(payload)
                .then(res => {
                    alert("1차 설문이 저장되었습니다. 이제 프로토콜 교육을 진행합니다.");
                    showStage('stage3-protocol');
                })
                .catch(err => alert("1차 설문 데이터 저장 중 에러 발생: " + err));
        });

        document.getElementById('nextToPostBtn').addEventListener('click', () => {
            postStartTime = Date.now();
            postQuestions = getRandomQuestions(allQuestions, 10); // 2차 설문용 10개 질문 선택
            createQuestions(document.getElementById('postSurveyForm'), postQuestions);
            showStage('stage4-post');
        });

        document.getElementById('submitFinalBtn').addEventListener('click', () => {
            const postSurveyForm = document.getElementById('postSurveyForm');
            const { correct, wrong, answers } = getSurveyResults(postSurveyForm, postQuestions);
            const duration = Math.round((Date.now() - postStartTime) / 1000);

            const payload = {
                respondent: userId,
                phase: "post",
                time: duration,
                correct: correct,
                wrong: wrong,
                answers: answers
            };

            sendData(payload)
                .then(res => {
                    alert("2차 설문이 저장되었습니다. 참여해주셔서 감사합니다!");
                    showStage('stage5-complete');
                })
                .catch(err => alert("2차 설문 데이터 저장 중 에러 발생: " + err));
        });

        // 초기 화면 표시
        document.addEventListener('DOMContentLoaded', () => {
            showStage('stage1-start');
        });
    </script>
</body>
</html>